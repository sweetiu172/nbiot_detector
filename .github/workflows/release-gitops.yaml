name: GitOps Release

on:
  workflow_run:
    workflows: ["Build and Push (with Container Scan)"]
    types: [completed]
    branches: [main]

env:
  DOCKER_IMAGE_NAME: minhtuan172/nbiot-detector-app
  DEPLOYMENT_PATCH: k8s/overlays/prod/patch-deployment.yaml

jobs:
  update-image:
    name: Update Image Tag in Manifests
    runs-on: ubuntu-latest
    environment: production   # ← pauses here until a required reviewer approves
    # Only run when the upstream workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          # No token here — uses the default GITHUB_TOKEN (always available)
          # The PAT is only injected at push time below

      - name: Derive image tag from triggering run
        id: tag
        run: |
          # Replicate the tag formula used in build_scan_push.yaml:
          #   <branch>-<run_number>-<sha_short>
          SHA="${{ github.event.workflow_run.head_sha }}"
          SHA_SHORT="${SHA:0:7}"
          RUN_NUMBER="${{ github.event.workflow_run.run_number }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          SAFE_BRANCH=$(echo "$BRANCH" | tr '/' '-')
          IMAGE_TAG="${SAFE_BRANCH}-${RUN_NUMBER}-${SHA_SHORT}"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Releasing image tag: ${IMAGE_TAG}"

      - name: Update image tag in Kustomize patch
        run: |
          IMAGE="${{ env.DOCKER_IMAGE_NAME }}:${{ steps.tag.outputs.image_tag }}"
          echo "Patching ${DEPLOYMENT_PATCH} → ${IMAGE}"
          sed -i "s|image: ${{ env.DOCKER_IMAGE_NAME }}:.*|image: ${IMAGE}|" ${{ env.DEPLOYMENT_PATCH }}
          grep "image:" ${{ env.DEPLOYMENT_PATCH }}

      - name: Commit and push to main
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Inject PAT into remote URL so the push can trigger ArgoCD webhooks
          git remote set-url origin \
            https://x-access-token:${{ secrets.GITOPS_TOKEN }}@github.com/${{ github.repository }}.git

          git add ${{ env.DEPLOYMENT_PATCH }}
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore(gitops): release ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.tag.outputs.image_tag }}"
          git push origin main
